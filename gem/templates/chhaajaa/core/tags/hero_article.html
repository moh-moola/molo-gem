{% load wagtailcore_tags wagtailimages_tags wagtailembeds_tags wagtailsettings_tags core_tags comments gem_tags molo_forms_tags %}
{% get_settings %}
{% if articles %}
  <div class="content--left">
  <div class="article-teaser">
    <div class="article-teaser__wrapper">
      <ul class="teaser-stacklist">
        {% for article in articles|slice:":1" %}
          <li class="teaser-stacklist__item">

            {# <!-- REVIEW IMAGE BACKUP --> #}
            {% for block in article.body %}
              {% if block.value.type == "video" %}
                {% if block.value.youtube_link %}
                  <div class="teaser-stacklist__iframe">
                    {% embed block.value.youtube_link %}
                  </div>
                  {% endif %}
              {% else %}
                {% if forloop.last and article.get_effective_image %}
                  <div class="teaser-stacklist__images">
                    {% image article.get_effective_image width-480 format-jpeg as teaser_thumbnail %}
                    <img loading="lazy" alt="{{ article.title }}" src="{{ teaser_thumbnail.url }}" class="teaser-stacklist__thumbnail"/>
                  </div>
                {% endif %}
              {% endif %}
            {% endfor %}
            {# <!-- END REVIEW IMAGE BACKUP --> #}

            <div class="teaser-stacklist__container">
              <h1 class="teaser-stacklist__title">
                {{ article.title|smarttruncatechars:100|safe}}
              </h1>
              <div class="teaser-stacklist__cta-buttons">
                {% load_reaction_question article as question %}
                {% if question %}
                <div class="reaction-questions">
                  <form class="reaction-questions__form" action="{% url 'reaction-vote' article.slug question.id %}" id="reaction-questions__form" method="post" novalidate>
                    {% csrf_token %}
                    <div class="reaction-questions__list">
                      {% load_choices_for_reaction_question question as choices %}
                        {% for choice in choices %}
                        {% load_user_choice_reaction_question question article choice as user_has_chosen %}
                        {% if user_has_chosen %}
                          <span class="reaction-questions__item" id="{{ choice.specific.get_main_language_page.id }}" onclick="set_choice({{ choice.specific.get_main_language_page.id }})" disabled=disabled>
                        {% else %}
                          <span class="reaction-questions__item" id="{{ choice.specific.get_main_language_page.id }}" onclick="set_choice({{ choice.specific.get_main_language_page.id }})">
                        {% endif %}
                            <label for="choice{{ forloop.counter }}" class="reaction-questions__label reaction-questions__label--{{ choice.title|slugify }}">
                              {% image choice.specific.image width-50 as reaction__icon %}
                              <div class="reaction-questions__icon" style="background-image: url('{{reaction__icon.url}}')"></div>
                              {{ choice.title|capfirst }}
                            </label>
                          </span>
                        {% endfor %}
                    </div>
                  </form>
                </div>
                {% endif %}
                <div class="vote__item">
                  <a href="#survey-form" class="vote__icon">{% trans "Poll" %}</a>
                </div>
                {% if article.is_commenting_enabled %}
                  {% if article.allow_commenting %}
                    {% if request.user.is_authenticated %}
                      <div class="comments__item">
                        <a href="#comment-form" class="comments__icon">{% trans "Comment" %}</a>
                      </div>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
              {% if article.subtitle %}
              <h4 class="teaser-stacklist__subtitle">{{ article.subtitle|smarttruncatechars:150|safe}}</h4>
              {% endif %}

              <div class="container">
                <div class="block">
                  <div class="content">
                    {% for block in article.body %}
                      {% if not block.block_type == 'media' %}
                        <div class="teaser-stacklist__excerpt excerpt excerpt-hidden">
                          {{block.value}}
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
              <a class="call-to-action__read-more show-more" href="{% pageurl article.specific %}">{% trans "Show more" %}</a>
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% for article in articles %}
    {% forms_list_for_pages page=article %}
    {% include "comments/comment_block.html" %}
  {% endfor %}
  {% block extra_js %}
    <script type="text/javascript">
      var frm = $('#reaction-questions__form');
      function set_choice(choice) {
        if (!$('#' + choice).attr('disabled') == true){
          $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: {
              csrfmiddlewaretoken: "{{ csrf_token }}",
              choice: choice,
              ajax: "True"
            },
            success: function () {
              $( ".reaction-questions__item" ).each(function( index ) {
                $(this).attr('disabled', false);
              });
              $("#" + choice).attr('disabled', true);
            }
          })
        }
      };
      const Utils = {
        addClass: function(element, theClass) {
          element.classList.add(theClass);
        },
        removeClass: function(element, theClass) {
          element.classList.remove(theClass);
        },
        showMore: function(element, excerpt) {
          element.addEventListener("click", event => {
            const linkText = event.target.textContent.toLowerCase();
            event.preventDefault();
              if (linkText == "show more") {
                element.textContent = "Show less";
                this.removeClass(excerpt, "excerpt-hidden");
                this.addClass(excerpt, "excerpt-visible");
              } else {
                element.textContent = "Show more";
                this.removeClass(excerpt, "excerpt-visible");
                this.addClass(excerpt, "excerpt-hidden");
              }
          });
        }
      };
      const ExcerptWidget = {
        showMore: function(showMoreLinksTarget, excerptTarget) {
          const showMoreLinks = document.querySelectorAll(showMoreLinksTarget);
          showMoreLinks.forEach(function(link) {
            const excerpt = link.previousElementSibling.querySelector(excerptTarget);
            Utils.showMore(link, excerpt);
          });
        }
      };
      ExcerptWidget.showMore('.show-more', '.excerpt');
    </script>
  {% endblock %}
</div>
{% endif %}
