{% load wagtailcore_tags wagtailimages_tags wagtailembeds_tags wagtailsettings_tags core_tags comments gem_tags molo_forms_tags %}
{% get_settings %}

{% if articles %}
  <ul class="teaser-stacklist">
  {% for article in articles|slice:":1" %}
  <li class="teaser-stacklist__item">
    {% for block in article.body %}
      {% if block.value.type == "video" %}
        {% if block.value.youtube_link %}
          <div class="teaser-stacklist__iframe">
            {% embed block.value.youtube_link %}
          </div>
        {% endif %}
      {% else %}
        {% if forloop.last and article.get_effective_image %}
          <div class="teaser-stacklist__images">
            <a href="{% pageurl article.specific %}" class="teaser-stacklist__anchor">
              {% image article.get_effective_image width-1080 format-jpeg as teaser_thumbnail %}
              <img alt="{{ article.title }}" src="{{ teaser_thumbnail.url }}" class="teaser-stacklist__thumbnail"/>
            </a>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}

    <div class="teaser-stacklist__container">
      <div class="teaser-stacklist__main">
        <h1 class="teaser-stacklist__title-secondary">
          {{ article.title}}
        </h1>
        {% if article.subtitle %}
          <h4 class="teaser-stacklist__subtitle">{{ article.subtitle }}</h4>
        {% endif %}

          {% for block in article.body %}
            {% if not block.block_type == 'media' %}
              <div class="teaser-stacklist__excerpt">
                <p>{{block.value}}</p>
              </div>
            {% endif %}
          {% endfor %}
      </div>
      <div class="teaser-stacklist__cta-buttons">
        {% load_reaction_question article as question %}
        {{question}}
        {% if question %}
        <div class="reaction-questions">
          <form class="reaction-questions__form" action="{% url 'reaction-vote' article.slug question.id %}" id="reaction-questions__form" method="post" novalidate>
            {% csrf_token %}
            <div class="reaction-questions__list">
              {% load_choices_for_reaction_question question as choices %}
                {% for choice in choices %}
                {% load_user_choice_reaction_question question article choice as user_has_chosen %}
                {% if user_has_chosen %}
                  <span class="reaction-questions__item" id="{{ choice.specific.get_main_language_page.id }}" onclick="set_choice({{ choice.specific.get_main_language_page.id }})" disabled=disabled>
                {% else %}
                  <span class="reaction-questions__item" id="{{ choice.specific.get_main_language_page.id }}" onclick="set_choice({{ choice.specific.get_main_language_page.id }})">
                {% endif %}
                    <label for="choice{{ forloop.counter }}" class="reaction-questions__label reaction-questions__label--{{ choice.title|slugify }}">
                      {% image choice.specific.image width-50 as reaction__icon %}
                      <div class="reaction-questions__icon" style="background-image: url('{{reaction__icon.url}}')"></div>
                      {{ choice.title|capfirst }}
                    </label>
                  </span>
                {% endfor %}
            </div>
          </form>
        </div>
        {% endif %}
        {% if settings.core.SiteSettings.facebook_sharing or settings.core.SiteSettings.twitter_sharing %}
          <div class="share__item">
            <a href="#" id="share_article" class="share__icon">{% trans "Share" %}</a>
            <div id="share_reveal" class="share__reveal">
              {% social_media_article page=article %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </li>
  {% endfor %}
  </ul>
{% endif %}

<script type="text/javascript">
  /* Reaction Question */
  var frm = $('#reaction-questions__form');
  function set_choice(choice) {
    if (!$('#' + choice).attr('disabled') == true){
      $.ajax({
        type: frm.attr('method'),
        url: frm.attr('action'),
        data: {
          csrfmiddlewaretoken: "{{ csrf_token }}",
          choice: choice,
          ajax: "True"
        },
        success: function () {
          $( ".reaction-questions__item" ).each(function( index ) {
            $(this).attr('disabled', false);
          });
          $("#" + choice).attr('disabled', true);
        }
      })
    }
  };
</script>
